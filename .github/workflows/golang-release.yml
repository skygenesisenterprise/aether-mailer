name: Release Go SDK

on:
  push:
    tags:
      - "v*-golang-sdk"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        default: "1.0.0"

env:
  GO_VERSION: "1.25"

jobs:
  debug:
    name: Debug Trigger Information
    runs-on: ubuntu-latest
    steps:
      - name: Print trigger information
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Actor: ${{ github.actor }}"
          echo "Is tag: ${{ startsWith(github.ref, 'refs/tags/') }}"
          echo "Ends with -golang-sdk: ${{ endsWith(github.ref, '-golang-sdk') }}"
          echo "Should run: ${{ startsWith(github.ref, 'refs/tags/') && endsWith(github.ref, '-golang-sdk') || github.event_name == 'workflow_dispatch' }}"

  release:
    name: Release Go SDK
    needs: debug
    if: startsWith(github.ref, 'refs/tags/') && endsWith(github.ref, '-golang-sdk') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Extract tag version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            PACKAGE_VERSION="${VERSION}"
            echo "Manual release version: $VERSION"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            PACKAGE_VERSION="${VERSION%-golang-sdk}"
            echo "Tag version: $VERSION"
            echo "Package version: $PACKAGE_VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        working-directory: ./package/golang
        run: go mod download

      - name: Run tests
        working-directory: ./package/golang
        run: go test -v -race -coverprofile=coverage.out .

      - name: Run go vet
        working-directory: ./package/golang
        run: go vet .

      - name: Run golint (optional)
        working-directory: ./package/golang
        continue-on-error: true
        run: |
          if command -v golint &> /dev/null; then
            golint .
          else
            echo "golint not available, skipping"
          fi

      - name: Generate documentation
        working-directory: ./package/golang
        run: |
          go install golang.org/x/tools/cmd/godoc@latest
          godoc -html github.com/skygenesisenterprise/aether-mailer/package/golang > docs.html || true

      - name: Build SDK Binaries
        working-directory: ./package/golang
        run: |
          platforms=("linux/amd64" "linux/arm64" "darwin/amd64" "darwin/arm64" "windows/amd64")
          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            output_dir="dist/${GOOS}-${GOARCH}"
            mkdir -p "$output_dir"
            BINARY_NAME="aether-mailer-sdk"
            [ "$GOOS" = "windows" ] && BINARY_NAME+=".exe"
            echo "Building for $GOOS/$GOARCH..."
            GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags="-s -w -X main.Version=${{ steps.version.outputs.package_version }} -X main.CommitSHA=${{ github.sha }} -X main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              -a -installsuffix cgo \
              -o "${output_dir}/${BINARY_NAME}" .
          done

      - name: Create release artifacts
        working-directory: ./package/golang
        run: |
          tar -czf aether-mailer-sdk-${{ steps.version.outputs.package_version }}.src.tar.gz \
            --exclude=.git --exclude=dist --exclude=coverage.out --exclude=docs.html .
          platforms=("linux/amd64" "linux/arm64" "darwin/amd64" "darwin/arm64" "windows/amd64")
          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            output_dir="dist/${GOOS}-${GOARCH}"
            if [ "$GOOS" = "windows" ]; then
              zip -r "aether-mailer-sdk-${{ steps.version.outputs.package_version }}-${GOOS}-${GOARCH}.zip" \
                -C "$output_dir" aether-mailer-sdk.exe README.md
            else
              tar -czf "aether-mailer-sdk-${{ steps.version.outputs.package_version }}-${GOOS}-${GOARCH}.tar.gz" \
                -C "$output_dir" aether-mailer-sdk ../README.md
            fi
          done

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Go SDK v${{ steps.version.outputs.package_version }}
          body: |
            ## Aether Mailer Go SDK v${{ steps.version.outputs.package_version }}
            Release triggered by tag: `${{ github.ref_name }}`
          draft: false
          prerelease: false
          files: |
            ./package/golang/aether-mailer-sdk-${{ steps.version.outputs.package_version }}.src.tar.gz
            ./package/golang/aether-mailer-sdk-${{ steps.version.outputs.package_version }}-*.tar.gz
            ./package/golang/aether-mailer-sdk-${{ steps.version.outputs.package_version }}-*.zip

      - name: Publish Go Module to GitHub Packages
        working-directory: ./package/golang
        run: |
          go mod tidy
          go list -m github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }}
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          if ! git rev-parse "v${{ steps.version.outputs.package_version }}" >/dev/null 2>&1; then
            git tag -a "v${{ steps.version.outputs.package_version }}" -m "Go SDK v${{ steps.version.outputs.package_version }}"
            git push origin "v${{ steps.version.outputs.package_version }}"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          exit-code: "0"
      - uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"

  publish-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: release
    if: success()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Generate documentation
        working-directory: ./package/golang
        run: |
          go install golang.org/x/tools/cmd/godoc@latest
          godoc -html github.com/skygenesisenterprise/aether-mailer/package/golang > documentation.html
