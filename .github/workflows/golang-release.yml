name: Release Go SDK

on:
  push:
    tags:
      - "v*-golang-sdk"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        default: "1.0.0"

env:
  GO_VERSION: "1.25"

jobs:
  debug:
    name: Debug Trigger Information
    runs-on: ubuntu-latest
    steps:
      - name: Print trigger information
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Actor: ${{ github.actor }}"
          echo "Is tag: ${{ startsWith(github.ref, 'refs/tags/') }}"
          echo "Ends with -golang-sdk: ${{ endsWith(github.ref, '-golang-sdk') }}"
          echo "Should run: ${{ startsWith(github.ref, 'refs/tags/') && endsWith(github.ref, '-golang-sdk') || github.event_name == 'workflow_dispatch' }}"

  release:
    name: Release Go SDK
    needs: debug
    if: startsWith(github.ref, 'refs/tags/') && endsWith(github.ref, '-golang-sdk') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Extract tag version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            PACKAGE_VERSION="${{ github.event.inputs.version }}"
            echo "Manual release version: $VERSION"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${tag#v}"
            # Remove the -golang-sdk suffix for package version
            PACKAGE_VERSION="${VERSION%-golang-sdk}"
            echo "Tag version: $VERSION"
            echo "Package version: $PACKAGE_VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        working-directory: ./package/golang
        run: go mod download

      - name: Run tests
        working-directory: ./package/golang
        run: |
          # Run tests with coverage (use module context instead of workspace)
          go test -v -race -coverprofile=coverage.out .

      - name: Run go vet
        working-directory: ./package/golang
        run: go vet .

      - name: Run golint (if available)
        working-directory: ./package/golang
        continue-on-error: true
        run: |
          if command -v golint &> /dev/null; then
            golint .
          else
            echo "golint not available, skipping"
          fi

      - name: Generate documentation
        working-directory: ./package/golang
        run: |
          # Install godoc
          go install golang.org/x/tools/cmd/godoc@latest

          # Generate docs
          godoc -html github.com/skygenesisenterprise/aether-mailer/package/golang > docs.html || true

      - name: Build SDK
        working-directory: ./package/golang
        run: |
          # Build module for multiple platforms using Docker
          platforms=("linux/amd64" "linux/arm64" "darwin/amd64" "darwin/arm64" "windows/amd64")

          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            
            output_dir="dist/${GOOS}-${GOARCH}"
            mkdir -p "$output_dir"
            
            echo "Building for $GOOS/$GOARCH using Docker..."
            
            # Build using Docker to ensure consistency
            docker buildx build \
              --platform linux/${GOARCH} \
              --build-arg TARGETOS=${GOOS} \
              --build-arg TARGETARCH=${GOARCH} \
              --build-arg VERSION=${{ steps.version.outputs.package_version }} \
              --build-arg COMMIT_SHA=${{ github.sha }} \
              --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
              --output type=local,dest=${output_dir} \
              -f Dockerfile \
              .
              
            # Rename binary if needed
            if [ "$GOOS" = "windows" ] && [ -f "${output_dir}/aether-mailer-sdk" ]; then
              mv "${output_dir}/aether-mailer-sdk" "${output_dir}/aether-mailer-sdk.exe"
            fi
          done

      - name: Create release artifacts
        working-directory: ./package/golang
        run: |
          # Create a source archive
          tar -czf aether-mailer-sdk-${{ steps.version.outputs.package_version }}.src.tar.gz \
            --exclude=.git \
            --exclude=dist \
            --exclude=coverage.out \
            --exclude=docs.html \
            .

          # Create platform-specific archives
          platforms=("linux/amd64" "linux/arm64" "darwin/amd64" "darwin/arm64" "windows/amd64")

          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            
            output_dir="dist/${GOOS}-${GOARCH}"
            
            if [ "$GOOS" = "windows" ]; then
              zip -r "aether-mailer-sdk-${{ steps.version.outputs.package_version }}-${GOOS}-${GOARCH}.zip" \
                -C "$output_dir" aether-mailer-sdk.exe README.md
            else
              tar -czf "aether-mailer-sdk-${{ steps.version.outputs.package_version }}-${GOOS}-${GOARCH}.tar.gz" \
                -C "$output_dir" aether-mailer-sdk ../README.md
            fi
          done

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Go SDK v${{ steps.version.outputs.package_version }}
          body: |
            ## Aether Mailer Go SDK v${{ steps.version.outputs.package_version }}

            ### ðŸš€ What's New
            This release includes the complete Go SDK for Aether Mailer with:

            - **Domain-Driven Design**: Clean architecture with separation of concerns
            - **Comprehensive Services**: User, Domain, Message, Quota, and Routing services
            - **Framework Agnostic**: Can be used with any HTTP/gRPC framework
            - **Multi-Node Support**: Built for distributed deployments
            - **Type Safety**: Full TypeScript-like type safety in Go
            - **Event System**: Domain events for loose coupling
            - **Configuration Management**: Comprehensive config system with validation

            ### ðŸ“¦ Installation

            ```bash
            go get github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }}
            ```

            ### ðŸ·ï¸ Release Tags
            This release was triggered by tag: `${{ github.ref_name }}`
            Format: `v{version}-golang-sdk` (e.g., `v1.0.0-golang-sdk`)

            ### ðŸ”— Quick Start

            ```go
            import "github.com/skygenesisenterprise/aether-mailer/package/golang"

            // Load configuration
            cfg := config.DefaultConfig()

            // Initialize SDK (provide your repository implementations)
            sdk, err := golang.NewSDK(cfg)

            // Use services
            user, err := sdk.Services.User.CreateUser(ctx, CreateUserRequest{
                Email:    "user@example.com",
                Username: "john_doe",
                Role:     domain.UserRoleUser,
            })
            ```

            ### ðŸ“š Documentation
            - [Go Documentation](https://pkg.go.dev/github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }})
            - [Full README](https://github.com/skygenesisenterprise/aether-mailer/blob/main/package/golang/README.md)

            ### ðŸ”„ Supported Platforms
            - Linux (x86_64, ARM64)
            - macOS (x86_64, ARM64)
            - Windows (x86_64)

            ---

            ðŸ› **Report Issues**: [GitHub Issues](https://github.com/skygenesisenterprise/aether-mailer/issues)
            ðŸ’¡ **Get Help**: [GitHub Discussions](https://github.com/skygenesisenterprise/aether-mailer/discussions)

            ðŸ“¦ **Made with â¤ï¸ by [Sky Genesis Enterprise](https://skygenesisenterprise.com)**
          draft: false
          prerelease: false
          files: |
            ./package/golang/aether-mailer-sdk-${{ steps.version.outputs.package_version }}.src.tar.gz
            ./package/golang/aether-mailer-sdk-${{ steps.version.outputs.package_version }}-*.tar.gz
            ./package/golang/aether-mailer-sdk-${{ steps.version.outputs.package_version }}-*.zip

      - name: Publish Go Module to GitHub Packages
        run: |
          cd package/golang

          # Prepare module for publishing
          go mod tidy

          # Verify module can be fetched
          echo "ðŸ“¦ Verifying Go module..."
          go list -m github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }}

          # Create a temporary directory for publishing
          mkdir -p publish-package

          # Copy all source files (excluding main.go which is just for demo)
          find . -name "*.go" -not -path "./main.go" -not -path "./dist/*" -not -path "./publish-package/*" | \
            xargs -I {} cp --parents {} publish-package/
          cp -r config domain errors repository service examples README.md LICENSE go.mod go.sum publish-package/

          # Create the package module path
          cd publish-package

          # Update go.mod for GitHub Packages with version
          sed -i 's|module github.com/skygenesisenterprise/aether-mailer/package/golang|module github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }}|' go.mod

          # Remove main.go as it's just for demonstration
          rm -f main.go

          echo "ðŸ“¦ Publishing Go module to GitHub Packages..."
          echo "Module: github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }}"

          # Create git tag for go module proxy
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git tag -a "v${{ steps.version.outputs.package_version }}" -m "Go SDK v${{ steps.version.outputs.package_version }}"
          git push origin "v${{ steps.version.outputs.package_version }}" || true

      - name: Generate Go Module Proxy Info
        working-directory: ./package/golang
        run: |
          # Generate go.sum for release verification
          go mod tidy
          go mod verify

          # Display module info
          echo "Module info:"
          go list -m github.com/skygenesisenterprise/aether-mailer/package/golang

      - name: Notify Aether Mailer App (optional)
        env:
          WEBHOOK_URL: ${{ secrets.AETHER_MAILER_WEBHOOK_URL }}
        if: env.WEBHOOK_URL != ''
        run: |
          # Send notification to Aether Mailer app
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "sdk_release",
              "package": "golang",
              "version": "${{ steps.version.outputs.package_version }}",
              "repository": "${{ github.repository }}",
              "release_url": "${{ steps.create_release.outputs.html_url }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }' || true

      - name: Build and Push Docker Image
        working-directory: ./package/golang
        run: |
          # Set up Docker Buildx
          docker buildx create --use --name multiarch --driver docker-container
          docker buildx inspect --bootstrap

          # Build and push for multiple platforms
          echo "ðŸ³ Building and pushing Docker image for multiple platforms..."

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-arg VERSION=${{ steps.version.outputs.package_version }} \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
            --tag ghcr.io/${{ github.repository }}/golang-sdk:v${{ steps.version.outputs.package_version }} \
            --tag ghcr.io/${{ github.repository }}/golang-sdk:latest \
            --push \
            -f Dockerfile \
            .
            
          echo "âœ… Docker image pushed to GitHub Container Registry"
          echo "ðŸ“¦ Available as: ghcr.io/${{ github.repository }}/golang-sdk:v${{ steps.version.outputs.package_version }}"

      - name: Update Go Module Proxy
        run: |
          cd package/golang

          # Ensure the module is properly versioned for go get
          echo "ðŸ”„ Updating Go module proxy..."

          # Create and push version tag if it doesn't exist
          if ! git rev-parse "v${{ steps.version.outputs.package_version }}" >/dev/null 2>&1; then
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git tag -a "v${{ steps.version.outputs.package_version }}" -m "Go SDK v${{ steps.version.outputs.package_version }}"
            git push origin "v${{ steps.version.outputs.package_version }}"
          fi

          # Trigger Go module proxy update
          echo "ðŸ“¡ Triggering Go module proxy for v${{ steps.version.outputs.package_version }}..."
          curl -X GET "https://proxy.golang.org/github.com/skygenesisenterprise/aether-mailer/package/golang/@v/${{ steps.version.outputs.package_version }}.info" \
            -H "User-Agent: GitHub Actions" \
            -s -o /dev/null || true
            
          # Verify module is available
          echo "âœ… Verifying module availability..."
          timeout 30s bash -c 'until go list -m github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }} >/dev/null 2>&1; do sleep 5; done' || true

          echo "ðŸŽ‰ Go module is now available via: go get github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }}"

      - name: Test Go Module Installation
        run: |
          # Test that the module can be installed via go get
          echo "ðŸ§ª Testing Go module installation..."

          # Create a temporary test directory
          mkdir -p /tmp/test-go-module
          cd /tmp/test-go-module

          # Initialize a test module
          go mod init test-module

          # Try to get the module
          echo "ðŸ“¦ Installing: github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }}"
          go get github.com/skygenesisenterprise/aether-mailer/package/golang@v${{ steps.version.outputs.package_version }}

          # Verify it can be imported
          cat > test.go << 'EOF'
          package main

          import (
              "fmt"
              "github.com/skygenesisenterprise/aether-mailer/package/golang/config"
              "github.com/skygenesisenterprise/aether-mailer/package/golang/domain"
          )

          func main() {
              cfg := config.DefaultConfig()
              user := &domain.User{
                  ID:   "test",
                  Email: "test@example.com",
              }
              fmt.Printf("âœ… Module imported successfully! Config host: %s, User email: %s\n", cfg.Database.Host, user.Email)
          }
          EOF

          # Run the test
          go run test.go

          echo "âœ… Go module installation test passed!"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          exit-code: "0"

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"

  publish-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: release
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Generate documentation
        working-directory: ./package/golang
        run: |
          # Install tools
          go install golang.org/x/tools/cmd/godoc@latest

          # Generate package documentation
          godoc -html github.com/skygenesisenterprise/aether-mailer/package/golang > documentation.html

      - name: Update GoDoc website info
        run: |
          # Trigger GoDoc update for the new version
          curl -s "https://godoc.org/github.com/skygenesisenterprise/aether-mailer/package/golang?status=yes" || true
