# Node.js Package Release Workflow for @aether-mailer/node
# This workflow builds, tests, and publishes the Node.js SDK to GitHub Packages and npm

name: Node.js Package Release

on:
  push:
    # Trigger on tags ending with -node for Node.js releases
    tags: ["v*.*.*-node"]
  pull_request:
    # Run tests on PRs targeting the node package
    paths:
      - "package/node/**"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string
      publish_npm:
        description: "Publish to npm registry"
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  # Build and test job
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      package_version: ${{ steps.version.outputs.package_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org/

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            VERSION="${VERSION%-node}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate version consistency
        run: |
          cd package/node
          PKG_VERSION=$(node -p "require('./package.json').version")
          VERSION_WITHOUT_SUFFIX="${{ steps.version.outputs.package_version }}"

          if [ "$VERSION_WITHOUT_SUFFIX" != "$PKG_VERSION" ]; then
            echo "âŒ Version mismatch:"
            echo "   Tag version: $VERSION_WITHOUT_SUFFIX"
            echo "   Package version: $PKG_VERSION"
            exit 1
          fi

          echo "âœ… Version validation passed: $PKG_VERSION"

      - name: Install dependencies
        run: |
          cd package/node
          pnpm install --frozen-lockfile

      - name: Type check
        run: |
          cd package/node
          pnpm run build

      - name: Lint code
        run: |
          cd package/node
          pnpm run lint

      - name: Run tests
        run: |
          cd package/node
          pnpm test

      - name: Generate coverage report
        if: github.event_name != 'pull_request'
        run: |
          cd package/node
          pnpm test --coverage

      - name: Upload coverage to Codecov
        if: github.event_name != 'pull_request'
        uses: codecov/codecov-action@v3
        with:
          file: ./package/node/coverage/lcov.info
          flags: nodejs
          name: nodejs-coverage

      - name: Build package
        run: |
          cd package/node
          pnpm run clean
          pnpm run build

      - name: Create package artifacts
        run: |
          cd package/node
          mkdir -p dist-artifacts

          # Create tarball for npm publishing
          npm pack --pack-destination ../dist-artifacts/

          # Copy source for debugging
          cp -r src ../dist-artifacts/
          cp package.json ../dist-artifacts/
          cp README.md ../dist-artifacts/
          cp tsconfig.json ../dist-artifacts/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: node-package-${{ steps.version.outputs.package_version }}
          path: |
            package/node/dist/
            package/node/dist-artifacts/
          retention-days: 30

  # Publish to GitHub Packages
  publish-github:
    name: Publish to GitHub Packages
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://npm.pkg.github.com/

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: node-package-${{ needs.build-and-test.outputs.version || github.ref_name }}
          path: artifacts

      - name: Restore package structure
        run: |
          cd package/node
          cp -r ../artifacts/dist/* ./
          cp -r ../artifacts/dist-artifacts/src ./src
          cp ../artifacts/dist-artifacts/package.json ./
          cp ../artifacts/dist-artifacts/README.md ./
          cp ../artifacts/dist-artifacts/tsconfig.json ./

      - name: Install dependencies
        run: |
          cd package/node
          pnpm install --frozen-lockfile

      - name: Publish to GitHub Packages
        run: |
          cd package/node
          npm publish --registry https://npm.pkg.github.com/
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

  # Publish to npm (optional)
  publish-npm:
    name: Publish to npm
    needs: build-and-test
    runs-on: ubuntu-latest
    if: (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch') && (github.event.inputs.publish_npm == 'true' || github.repository_owner == 'skygenesisenterprise')

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org/

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: node-package-${{ needs.build-and-test.outputs.version || github.ref_name }}
          path: artifacts

      - name: Restore package structure
        run: |
          cd package/node
          cp -r ../artifacts/dist/* ./
          cp -r ../artifacts/dist-artifacts/src ./src
          cp ../artifacts/dist-artifacts/package.json ./
          cp ../artifacts/dist-artifacts/README.md ./
          cp ../artifacts/dist-artifacts/tsconfig.json ./

      - name: Install dependencies
        run: |
          cd package/node
          pnpm install --frozen-lockfile

      - name: Publish to npm
        run: |
          cd package/node
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [build-and-test, publish-github]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            VERSION="${VERSION%-node}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: node-package-${{ needs.build-and-test.outputs.package_version }}
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Aether Mailer Node.js SDK v${{ steps.version.outputs.version }}
          body: |
            ## ðŸš€ Aether Mailer Node.js SDK v${{ steps.version.outputs.version }}

            ### âœ¨ What's New
            - Production-ready Node.js SDK for Aether Mailer
            - Full TypeScript support with comprehensive type definitions
            - Complete API coverage for authentication, user management, domains, and emails
            - Robust error handling and retry mechanisms
            - Modern ES modules with CommonJS compatibility

            ### ðŸ”§ Features
            - ðŸ—ï¸ **TypeScript-First**: Full type safety with comprehensive definitions
            - ðŸ” **Authentication**: JWT-based authentication with automatic token refresh
            - ðŸ“§ **Email Operations**: Complete email sending, receiving, and management
            - ðŸ‘¤ **User Management**: CRUD operations for user accounts
            - ðŸŒ **Domain Management**: Multi-domain configuration and verification
            - ðŸ› ï¸ **Admin API**: Server administration and monitoring capabilities
            - ðŸ”„ **Retry Logic**: Automatic retry for transient failures
            - ðŸ“ **Error Handling**: Comprehensive error types and handling

            ### ðŸ“¦ Installation
            ```bash
            # Using pnpm (recommended)
            pnpm add @aether-mailer/node

            # Using npm
            npm install @aether-mailer/node

            # Using yarn
            yarn add @aether-mailer/node
            ```

            ### ðŸš€ Quick Start
            ```typescript
            import { AetherMailerClient } from "@aether-mailer/node";

            const client = new AetherMailerClient({
              baseURL: "https://api.aether-mailer.com",
            });

            // Authenticate
            await client.auth.login({
              email: "user@example.com",
              password: "password",
            });

            // Send email
            await client.emails.send({
              to: "recipient@example.com",
              subject: "Hello from Aether Mailer",
              body: "This is a test email",
            });
            ```

            ### ðŸ”— Links
            - [Documentation](https://github.com/skygenesisenterprise/aether-mailer/blob/main/package/node/README.md)
            - [GitHub Package](https://github.com/skygenesisenterprise/aether-mailer/pkgs/npm/@aether-mailer-node)
            - [npm Package](https://www.npmjs.com/package/@aether-mailer-node)
            - [Report Issues](https://github.com/skygenesisenterprise/aether-mailer/issues)

            ### ðŸ“‹ Package Information
            - **Version**: ${{ steps.version.outputs.version }}
            - **Node.js**: 18+
            - **TypeScript**: 5.x (Strict Mode)
            - **License**: MIT

            ### ðŸ” Security
            - âœ… JWT token management
            - âœ… Secure HTTP client with Axios
            - âœ… Input validation and sanitization
            - âœ… No hardcoded secrets or credentials

            ### ðŸ“Š Testing
            - âœ… Jest test suite with comprehensive coverage
            - âœ… TypeScript strict mode compliance
            - âœ… ESLint code quality checks
            - âœ… Automated CI/CD pipeline

            ---
            **ðŸ”§ Built with â¤ï¸ by [Sky Genesis Enterprise](https://skygenesisenterprise.com)**

            *This release is production-ready and fully compatible with Node.js 18+ and TypeScript 5.x.*
          files: |
            artifacts/dist-artifacts/*.tgz
            package/node/README.md
            package/node/LICENSE
          draft: false
          prerelease: false
          generate_release_notes: true

  # Update documentation (optional)
  update-docs:
    name: Update Documentation
    needs: create-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && github.repository_owner == 'skygenesisenterprise'

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update package version in docs
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          VERSION="${VERSION%-node}"

          # Update version in main README if it references the node package
          if grep -q "@aether-mailer/node" README.md; then
            sed -i "s/@aether-mailer\/node@.*/@aether-mailer\/node@$VERSION/g" README.md
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add README.md
            git diff --staged --quiet || git commit -m "docs: update node package version to $VERSION"
            git push
          fi

  # Summary
  summary:
    name: Release Summary
    needs: [build-and-test, publish-github, publish-npm, create-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            VERSION="${VERSION%-node}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Node.js SDK Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Tasks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TypeScript build completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code linting passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Jest tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Package built and validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Published to GitHub Packages" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.publish-npm.result }}" == "success" ]; then
            echo "- âœ… Published to npm registry" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- âœ… GitHub release created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Package Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: \`@aether-mailer/node\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Package**: [View Package](https://github.com/${{ github.repository }}/pkgs/npm/@aether-mailer-node)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.publish-npm.result }}" == "success" ]; then
            echo "- **npm Package**: [View on npm](https://www.npmjs.com/package/@aether-mailer/node)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **GitHub Release**: [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Usage" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'npm install @aether-mailer/node@${{ steps.version.outputs.version }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Your Aether Mailer Node.js SDK is ready for production!**" >> $GITHUB_STEP_SUMMARY
